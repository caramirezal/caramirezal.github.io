<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>IRTG COURSE: INTRODUCTION TO R</title>
  <meta name="description" content="IRTG COURSE: INTRODUCTION TO R" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="IRTG COURSE: INTRODUCTION TO R" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="IRTG COURSE: INTRODUCTION TO R" />
  
  
  

<meta name="author" content="Carl Herrmann &amp; Carlos Ramirez" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  


<script src="libs/header-attrs-2.6/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="#intro"><i class="fa fa-check"></i><b>1</b> scRNA-Seq analysis</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="#quantifying-gene-expression-in-single-cells"><i class="fa fa-check"></i><b>1.1</b> Quantifying gene expression in single cells</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="#standard-preprocessing-using-seurat"><i class="fa fa-check"></i><b>1.2</b> Standard Preprocessing using Seurat</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="#creating-seurat-object"><i class="fa fa-check"></i><b>1.3</b> Creating Seurat object</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="#quality-control"><i class="fa fa-check"></i><b>1.4</b> Quality control</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="#feature-selection"><i class="fa fa-check"></i><b>1.5</b> Feature selection</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="#normalization"><i class="fa fa-check"></i><b>1.6</b> Normalization</a></li>
<li class="chapter" data-level="1.7" data-path="index.html"><a href="#dimensional-reduction"><i class="fa fa-check"></i><b>1.7</b> Dimensional reduction</a></li>
<li class="chapter" data-level="1.8" data-path="index.html"><a href="#cell-clustering"><i class="fa fa-check"></i><b>1.8</b> Cell clustering</a></li>
<li class="chapter" data-level="1.9" data-path="index.html"><a href="#cluster-visualization"><i class="fa fa-check"></i><b>1.9</b> Cluster visualization</a>
<ul>
<li class="chapter" data-level="1.9.1" data-path="index.html"><a href="#umap"><i class="fa fa-check"></i><b>1.9.1</b> UMAP</a></li>
</ul></li>
<li class="chapter" data-level="1.10" data-path="index.html"><a href="#differential-expression-analysis"><i class="fa fa-check"></i><b>1.10</b> Differential Expression Analysis</a></li>
<li class="chapter" data-level="1.11" data-path="index.html"><a href="#markers-visualization"><i class="fa fa-check"></i><b>1.11</b> Markers visualization</a></li>
<li class="chapter" data-level="1.12" data-path="index.html"><a href="#section"><i class="fa fa-check"></i><b>1.12</b> </a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">IRTG COURSE: INTRODUCTION TO R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="header">
<h1 class="title">IRTG COURSE: INTRODUCTION TO R</h1>
<p class="author"><em>Carl Herrmann &amp; Carlos Ramirez</em></p>
<p class="date" style="margin-top: 1.5em;"><em>25 May, 2021</em></p>
</div>
<div id="intro" class="section level1" number="1">
<h1><span class="header-section-number">1</span> scRNA-Seq analysis</h1>
<p>We will use available data from 10X genomics of Peripheral Blood Mononuclear cells (PBMC). In order
to speed up the process only a subset of 500 cells are going to be processed here. Here, we will
perform the following tasks:</p>
<ul>
<li>Definition of a Seurat object from a matrix of counts</li>
<li>Quality Control (QC) of the cell samples</li>
<li>Filtering</li>
<li>Dimensional reduction</li>
<li>Clustering</li>
<li>Differential expression</li>
<li>Visualization of markers</li>
</ul>
<div id="quantifying-gene-expression-in-single-cells" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> Quantifying gene expression in single cells</h2>
<p>Genes are expressed in cells by the synthesis of mRNA molecules. Quantification of gene expression
in single cells consists of counting and mapping sequenced reads to each gene in each cell. The
outcome of this process is a count matrix, which is a discrete matrix of integers corresponding
to the number of RNA molecules associated to each gene and cell. The count matrix usually has
genes as rows and cells in columns.</p>
<p>In the next lines we will load the matrix of UMI counts into a variable called <code>pbmc.mtx</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Dependencies</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rmarkdown)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">333</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Loading example data</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>pbmc_url  <span class="ot">&lt;-</span> <span class="st">&#39;https://github.com/caramirezal/caramirezal.github.io/raw/master/bookdown-minimal/data/pbmc_10X_500_cells.mtx.rds&#39;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>pbmc.mtx <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">url</span>(pbmc_url))</span></code></pre></div>
<p>As can be seen from the output of the function <code>dim(pbmc.mtx)</code> the matrix contains rows (genes) and 500 columns (cells).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(pbmc.mtx)</span></code></pre></div>
<pre><code>## [1] 13714   500</code></pre>
<p>To have a glimpse of the appearance of this matrix we print the first 5 rows and first 5 columns. It can
be seen that the matrix object is a particular array called sparse Matrix. These types of matrices are
specially efficient to store numerical arrays which are very sparse (full of zeroes) as is the case
for single cell count matrices data.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>pbmc.mtx[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>## 5 x 5 sparse Matrix of class &quot;dgCMatrix&quot;
##               AAAGAGACGGACTT-1 AAAGATCTGGGCAA-1 AAAGCAGATATCGG-1
## AL627309.1                   .                .                .
## AP006222.2                   .                .                .
## RP11-206L10.2                .                .                .
## RP11-206L10.9                .                .                .
## LINC00115                    .                .                .
##               AAAGTTTGATCACG-1 AAATCAACCCTATT-1
## AL627309.1                   .                .
## AP006222.2                   .                .
## RP11-206L10.2                .                .
## RP11-206L10.9                .                .
## LINC00115                    .                .</code></pre>
<p>We can start from different types of arrays apart from sparse matrices as data frames or hd5
objects just to give some examples. The format in which the matrix is provided might also vary from
excel files, tsv, csv, rds, etc. Usually this formats can be converted into each other, however, the
methods for such transformation are so different and specific that we cannot covered here.</p>
</div>
<div id="standard-preprocessing-using-seurat" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> Standard Preprocessing using Seurat</h2>
<p>Some standard steps are usually carried out in scRNA-Seq prior to further analysis as QC, dimensional
reduction and marker visualization. Here, we will use the Seurat R package to perform these steps which
is increasingly becoming the most popular tool, however, there are some other options as SingleCellExperiment
in R and scanpy available for python. First, we need to define a Seurat object.</p>
</div>
<div id="creating-seurat-object" class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> Creating Seurat object</h2>
<p>We create a Seurat object using the <code>CreateSeuratObject</code> function as follows. Use the <code>?function</code> helper
in R to get information about the parameters that are need to be provided to the function.</p>
<ul>
<li>counts - a count matrix. It can be a matrix, sparse matrix or dataframe.</li>
<li>project - A single character string. Correspond to a arbitrary name to label the object.</li>
<li>assay - A single character string. An arbitrary name that usually is assigned to label the
type of sequencing information, for example, RNA, spliced RNA, ATAC, etc…</li>
<li>min.cells - An integer. Indicates a threshold of the number of cells for which a feature was
recorded. Cells belowe that threshold will be filtered out.</li>
<li>min.features - An integer. Similar to min cells but for the number of features of a cell.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Seurat)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>pbmc.seurat <span class="ot">&lt;-</span> <span class="fu">CreateSeuratObject</span>(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">counts =</span> pbmc.mtx, </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">project =</span> <span class="st">&#39;PBMC&#39;</span>, </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">assay =</span> <span class="st">&#39;RNA&#39;</span>, </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">min.cells =</span> <span class="dv">1</span>, </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">min.features =</span> <span class="dv">1</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>The variable <code>pbmc.seurat</code> now contains the Seurat object that we can feed into the package.
If we print the variable we get information about the number of genes and cells.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>pbmc.seurat</span></code></pre></div>
<pre><code>## An object of class Seurat 
## 12673 features across 500 samples within 1 assay 
## Active assay: RNA (12673 features, 0 variable features)</code></pre>
</div>
<div id="quality-control" class="section level2" number="1.4">
<h2><span class="header-section-number">1.4</span> Quality control</h2>
<p>Filtering cells with low sequencing quality is a very important step since it can greatly
impact in further analysis. Quality check and control often requires to visualize and inspect
samples in order to determine appropiate thresholds. Threshold values might vary from one
dataset to another, so no hard threshold rule can be applied equally to every case.</p>
<p>We will examine the number of UMI counts, the number of RNA features and the percentage of reads
of mitochondrial genes.</p>
<p>We will first calculate the percentage of UMI counts of reads mapped to mitochondrial genes. This
step most be manually done since is based on a <em>priori knowledge</em> of which genes corresponds to
mitochondrial genes.
In this case, genes are annotated using human ensembl gene symbol annotations mitochondrial
genes are annotated starting with a <code>MT-</code> string.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>pbmc.seurat[[<span class="st">&quot;percent.mt&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">PercentageFeatureSet</span>(pbmc.seurat, <span class="at">pattern =</span> <span class="st">&quot;^MT-&quot;</span>)</span></code></pre></div>
<p>Then, we can visualize the following metrics.</p>
<ul>
<li><p>Number of features - Correspond to the number of different mapped genomic features. For example, in the
case of scRNA-Seq features corresponds to genes, in ATAC-Seq to genomic ranges, etc. High number of features
can indicate doublets and empty cells. Usually between 1 and 30000.</p></li>
<li><p>Number of counts - Number of mapped reads. It can also indicate the presence of doublets and empty
droplet. It’s generally correlated to the number of features. Usually between 1 and 20000.</p></li>
<li><p>Percentage of mitochondrial genes - Percentage of mapped reads that are annotated to mitochondrial
genes. The presence of high levels of % of mitochondrial genes can suggest that a cell have lost
its membrane integrity, that the cytoplasm has been leaked off and only the mitochondria was retained.
Usually from 0 to 10.</p></li>
</ul>
<p>We can plot these metrics using the function <code>VlnPlot()</code> as follows:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">VlnPlot</span>(pbmc.seurat, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">&#39;nFeature_RNA&#39;</span>, <span class="st">&#39;nCount_RNA&#39;</span>, <span class="st">&#39;percent.mt&#39;</span>))</span></code></pre></div>
<p><img src="course_files/figure-html/unnamed-chunk-2-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The violin plots show the values of the metrics for each cell along with an adjusted violin
distribution.</p>
</div>
<div id="feature-selection" class="section level2" number="1.5">
<h2><span class="header-section-number">1.5</span> Feature selection</h2>
<p>Because of the sparsity in the sequencing data many genes or features are almost no expressed.
Additionally, some genes are constantly expressed across cells. These features are then probably
not playing any function in cells and on the other hand can just add noise and unnecessary complexity
to further analysis. Then, it’s usual to remove genes with very low variability and to select
only top highly variable genes (HVG).</p>
<p>We will use the function <code>FindVariableFeatures()</code> to calculate the top most variable genes.
The parameter nfeatures is used to set the number of top selected genes. We set to the top
1000 features.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>pbmc.seurat <span class="ot">&lt;-</span> <span class="fu">FindVariableFeatures</span>(pbmc.seurat, <span class="at">nfeatures =</span> <span class="dv">1000</span>)</span></code></pre></div>
<p>We can access to the top 1000 variable features using the VariableFeatures function. In the next
chunk we display the top first 6 (head) of this set.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">VariableFeatures</span>(pbmc.seurat))</span></code></pre></div>
<pre><code>## [1] &quot;S100A9&quot; &quot;LYZ&quot;    &quot;FTL&quot;    &quot;GNLY&quot;   &quot;FTH1&quot;   &quot;S100A8&quot;</code></pre>
<p>In the next scatter plot we can see the average expression <em>vs</em> the standardized variance for each feature.
Genes in red are the selected HVG.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot variable features with and without labels</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">VariableFeaturePlot</span>(pbmc.seurat)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">LabelPoints</span>(<span class="at">plot =</span> plot1, </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">points =</span> <span class="fu">head</span>(<span class="fu">VariableFeatures</span>(pbmc.seurat),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                                   <span class="dv">10</span>), </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">repel =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>plot1 </span></code></pre></div>
<p><img src="course_files/figure-html/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>For further analysis we will use only HVGs.</p>
</div>
<div id="normalization" class="section level2" number="1.6">
<h2><span class="header-section-number">1.6</span> Normalization</h2>
<p>There are several methods for normalization of scRNA-Seq data. A commonly
used strategy is the log normalization which basically corrects sequencing
deep in cells by dividing each feature by the total number of counts and
then multiplied the result by a factor, usually 10000, and finally the
values are log transformed.</p>
<p>Log normalization can be implemented by using the <code>NormalizeData()</code> function.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>pbmc.seurat <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(pbmc.seurat)</span></code></pre></div>
<p>Then, in order to make genes measurements more comparable log transformed
values are scaled in a way that the media is equal to zero and the variance
is equal to 1 as follows:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>pbmc.seurat <span class="ot">&lt;-</span> <span class="fu">ScaleData</span>(pbmc.seurat)</span></code></pre></div>
</div>
<div id="dimensional-reduction" class="section level2" number="1.7">
<h2><span class="header-section-number">1.7</span> Dimensional reduction</h2>
<p>The size of scRNA-Seq matrices can be huge and for this reason techniques to reduce the dimensionality
of this data are used. Here, we will use PCA, a very common techniques for dimension
reduction and visualization.</p>
<p>We will run a PCA using the already calculated top 1000 HVGs using the function <code>RunPCA()</code>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>pbmc.seurat <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(pbmc.seurat, </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">features =</span> <span class="fu">VariableFeatures</span>(pbmc.seurat))</span></code></pre></div>
<p>We can assess the dimensionality, a measure of the complexity, by using an
elbow plot of the standard deviation for each principal component (PC)
from the PCA.</p>
<p>We will use the function <code>ElbowPlot()</code>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ElbowPlot</span>(pbmc.seurat)</span></code></pre></div>
<p><img src="course_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The PC components in a PCA reflects corresponds to the directions in which
more variability is observed. These PCs are ranked by using the eigenvalues
of the covariance matrix. We can the plot a Elbow or joystick plot of the
standard deviation and the rank of each PC. Top ranked PCs are expected to
have higher values of variability and then to gradually decrease. So, we
can use the elbow plot representation to keep PCs from the top to the bottom
until we do not see further variability changes, in these case we can use
the number of PC equal to 7.</p>
</div>
<div id="cell-clustering" class="section level2" number="1.8">
<h2><span class="header-section-number">1.8</span> Cell clustering</h2>
<p>Detection of groups or cluster of cells is an important task in scRNA-Seq
analysis. Seurat implements a clustering method based in KNN graphs and
community detection using the Louvain algorithm. An important parameter
for clustering is the resolution which can be set to increase/reduce the
granularity of the clusters.</p>
<p>This method can be implemented by using the functions <code>FindNeighbors()</code> and
<code>FindClusters()</code> as follows:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>pbmc.seurat <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(pbmc.seurat)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>pbmc.seurat <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(pbmc.seurat, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">resolution =</span> <span class="fl">0.1</span>, </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>The results of the clustering are stored in the Seurat metadata slot, which
can be accessed as a simple data.frame using the <code>$</code> operator. A column vector
containing each cluster for each cell is name <code>seurat_cluster</code> as shown next:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pbmc.seurat<span class="sc">$</span>seurat_clusters)</span></code></pre></div>
<pre><code>## AAAGAGACGGACTT-1 AAAGATCTGGGCAA-1 AAAGCAGATATCGG-1 AAAGTTTGATCACG-1 
##                2                1                1                3 
## AAATCAACCCTATT-1 AAATGTTGTGGCAT-1 
##                1                1 
## Levels: 0 1 2 3</code></pre>
<p>There are 5 different clusters, labeled from 0 to 4 and stored like a factor.
We can plot a frequency table of the number of cells assigned to each cluster
by the algorithm.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(pbmc.seurat<span class="sc">$</span>seurat_clusters) </span></code></pre></div>
<pre><code>## 
##   0   1   2   3 
## 224 129  85  62</code></pre>
<p>So, 224 cells were assigned to the cluster 0.</p>
</div>
<div id="cluster-visualization" class="section level2" number="1.9">
<h2><span class="header-section-number">1.9</span> Cluster visualization</h2>
<p>Transformations like PCA, tSNE or UMAP are used to project multidimensional
data into 2D or 3D representations that can be visualized at the expense
of the lose of information. tSNE and UMAP transformations aims to preserve
global relations between sample points. We will use UMAPs to visualize the
scRNA-Seq data from PBMC.</p>
<div id="umap" class="section level3" number="1.9.1">
<h3><span class="header-section-number">1.9.1</span> UMAP</h3>
<p>We can use the <code>RunUMAP</code> function to calculate the UMAP transformation. The
calculation of a UMAP projection can intensive computationally and is
usually carried out on already dimensional reduced data using, for example,
PCA. The RunUMAP from seurat by default will use the PCA reduced data, the
parameter <code>dims</code> sets the number of dimensions, PCs that should be used, as
we saw we can use 7 PCs which are the ones in which there is more variability.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>pbmc.seurat <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(pbmc.seurat, </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>After the calculation of the UMAP we can visualize it using the function
<code>DimPlot()</code>.</p>
<details>
<summary>
How to improve the clustering?
</summary>
<br>
Try different higher values for the resolution parameter.
</details>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DimPlot</span>(pbmc.seurat)</span></code></pre></div>
<p><img src="course_files/figure-html/umap_plot-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="differential-expression-analysis" class="section level2" number="1.10">
<h2><span class="header-section-number">1.10</span> Differential Expression Analysis</h2>
<p>The main advantage of using scRNA-Seq technologies is the possibility of
assessing cell type specificity and heterogeneity, which is not possible while
using bulk assays.</p>
<p>We should expect that some of the identified clusters in the UMAP might correspond
to distinct cell types. The assignation of cell types identities is not always
straightforward, some clusters might still contain some variability, and
additionally, different clusters might correspond to the same cell type at a
different functional, metabolic or cycling point.</p>
<p>Cell type profiling is generally done by assessing the expression of markers.
This task can be done manually by inspecting markers in dimensional reduced data
projected in UMAP or tSNE. It can also be done in a automatic manner scoring
cells using gene signatures, which are lists of marker genes. Scores are generally
based in the median expression of all the markers. Using scores has the advantage
or reducing bias due to the arbitrary selection of markers.</p>
<p>Finding differential expressed markers is important for cluster profiling and
identification. We will use the <code>FindAllMarkers()</code>, this functions performs
a statistical test comparing the distribution of gene expression values for
each gene separately comparing one assigned cell type cluster (in this case
the <code>seurat_clusters</code> column) <em>vs</em> the rest.</p>
<p>First, we will set up the column used to define the clusters using the
function <code>Idents()</code>.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(pbmc.seurat) <span class="ot">&lt;-</span> pbmc.seurat<span class="sc">$</span>seurat_clusters</span></code></pre></div>
<p>Now we can calculate the DEGs.
There are several parameters for <code>FindAllMarkers()</code>, we will discuss
<code>logfc.threshold</code>, <code>min.pct</code> and <code>min.cells.feature</code> that corresponds to the threshold of gene
expression fold change, the minimum percentage of cells expressing the marker
and the minimum of cells expressing (counts &gt; 0) the feature. These parameters
are used to filter out genes prior calculating DEGs. Lowering the values of these
parameters will increase the sensibility of the method at the expense of
increasing computation time.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>pbmc.degs <span class="ot">&lt;-</span> <span class="fu">FindAllMarkers</span>(pbmc.seurat, </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">logfc.threshold =</span> <span class="dv">1</span>, </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">min.pct =</span> <span class="fl">0.05</span>, </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">min.cells.feature =</span> <span class="dv">10</span>, </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>The output <code>pbmc.degs</code> consist of a data frame contanning the DEGs with
p-vales, p-adjusted values and log fold change values for each gene as
we can see next:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pbmc.degs)</span></code></pre></div>
<pre><code>##                 p_val avg_log2FC pct.1 pct.2    p_val_adj cluster     gene
## LDHB     1.904954e-47   1.676499 0.924 0.489 2.414148e-43       0     LDHB
## CD74     3.347159e-46  -2.889919 0.746 0.946 4.241855e-42       0     CD74
## CYBA     6.600780e-46  -1.641294 0.750 0.953 8.365168e-42       0     CYBA
## HLA-DRB1 9.890935e-44  -3.333839 0.103 0.703 1.253478e-39       0 HLA-DRB1
## HLA-DRA  2.565779e-42  -4.164359 0.295 0.768 3.251612e-38       0  HLA-DRA
## HLA-DPA1 8.697736e-37  -2.954716 0.205 0.717 1.102264e-32       0 HLA-DPA1</code></pre>
<p>We can make a vulcano plot using <code>ggplot</code>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)         <span class="do">## for handling data frames</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>pbmc.degs <span class="sc">%&gt;%</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(avg_log2FC))) <span class="sc">%&gt;%</span>       <span class="do">## Arranging genes by FC</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rank=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(pbmc.degs)) <span class="sc">%&gt;%</span>        <span class="do">## Ranking markers by FC</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">highlight=</span><span class="fu">ifelse</span>(rank<span class="sc">&lt;</span><span class="dv">20</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span> <span class="do">## highlighting top FC markers</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_label=</span><span class="fu">ifelse</span>(highlight<span class="sc">==</span><span class="cn">TRUE</span>, gene, <span class="st">&#39;&#39;</span>)) <span class="sc">%&gt;%</span> <span class="do">## Adding labels for top markers</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>avg_log2FC, <span class="at">y=</span><span class="sc">-</span><span class="fu">log10</span>(p_val_adj),</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour=</span>highlight,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">label=</span>gene_label)) <span class="sc">+</span>         <span class="do">## adding labels for top markers</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_text_repel</span>() <span class="sc">+</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="course_files/figure-html/vulcano_plot-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="markers-visualization" class="section level2" number="1.11">
<h2><span class="header-section-number">1.11</span> Markers visualization</h2>
<p>First, we will take top 10 ranked genes based in Log FC and visualize their
expression in clusters using a heatmap representation.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>top10 <span class="ot">&lt;-</span> pbmc.degs <span class="sc">%&gt;%</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>             <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>             <span class="fu">top_n</span>(<span class="at">n =</span> <span class="dv">10</span>, <span class="at">wt =</span> avg_log2FC)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="fu">DoHeatmap</span>(pbmc.seurat, <span class="at">features =</span> top10<span class="sc">$</span>gene) <span class="sc">+</span> <span class="fu">NoLegend</span>()</span></code></pre></div>
<p><img src="course_files/figure-html/heatmap-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>IL-7 is a marker for naive CD4+ T cells, while GZMB is a marker for CD8 T cells.
Then, we can tentatively consider cluster 0 and 2 as CD4 and CD8 T cells,
respectively.
We can visualize additional known canonical markers in order to assign cell
categories.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>canonical_markers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;IL7R&#39;</span>,     <span class="do">## CD4+ cell</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;CCR7&#39;</span>,     <span class="do">## Naive CD4+ T cell</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;CD8A&#39;</span>,     <span class="do">## CD8+</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;NKG7&#39;</span>,     <span class="do">## NK</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;MS4A1&#39;</span>,    <span class="do">## B cell marker</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;FCGR3A&#39;</span>,   <span class="do">## Mono</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;FCER1A&#39;</span>,   <span class="do">## DC</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;CD14&#39;</span>     <span class="do">## Mono</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>                       )</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="fu">FeaturePlot</span>(pbmc.seurat, <span class="at">features =</span> canonical_markers)</span></code></pre></div>
<p><img src="course_files/figure-html/umap_markers_vis-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Now, we will annotate the cells with their identified identities in the seurat
object. We will map the cluster names as follows:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>mapping <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">seurat_cluster=</span><span class="fu">c</span>(<span class="st">&#39;0&#39;</span>, <span class="st">&#39;1&#39;</span>, <span class="st">&#39;2&#39;</span>, <span class="st">&#39;3&#39;</span>),</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">cell_type=</span><span class="fu">c</span>(<span class="st">&#39;Lymphocyte&#39;</span>, <span class="st">&#39;B cell&#39;</span>, <span class="st">&#39;Lymphocyte&#39;</span>,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;Monocyte&#39;</span>))</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>mapping</span></code></pre></div>
<pre><code>##   seurat_cluster  cell_type
## 1              0 Lymphocyte
## 2              1     B cell
## 3              2 Lymphocyte
## 4              3   Monocyte</code></pre>
<p>To assign the new labels we can use the map function from the plyr R package
as follows:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>pbmc.seurat<span class="sc">$</span><span class="st">&#39;cell_type&#39;</span> <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">mapvalues</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> pbmc.seurat<span class="sc">$</span>seurat_clusters,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">from =</span> mapping<span class="sc">$</span>seurat_cluster,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">to =</span> mapping<span class="sc">$</span>cell_type</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Now, we can plot the clusters with the assigned cell types.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DimPlot</span>(pbmc.seurat, </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">group.by =</span> <span class="st">&#39;cell_type&#39;</span>,   <span class="do">## set the column to use as category</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="cn">TRUE</span>)  <span class="sc">+</span>          <span class="do">## label clusters</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">NoLegend</span>()                <span class="do">## remove legends</span></span></code></pre></div>
<p><img src="course_files/figure-html/cell_types-1.png" width="672" style="display: block; margin: auto;" /></p>

</div>
<div id="section" class="section level2" number="1.12">
<h2><span class="header-section-number">1.12</span> </h2>

</div>
</div>
            </section>

          </div>
        </div>
      </div>


    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
