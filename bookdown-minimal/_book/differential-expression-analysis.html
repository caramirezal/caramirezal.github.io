<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8 Differential Expression Analysis | IRTG COURSE: INTRODUCTION TO R</title>
  <meta name="description" content="8 Differential Expression Analysis | IRTG COURSE: INTRODUCTION TO R" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="8 Differential Expression Analysis | IRTG COURSE: INTRODUCTION TO R" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8 Differential Expression Analysis | IRTG COURSE: INTRODUCTION TO R" />
  
  
  

<meta name="author" content="Carl Herrmann &amp; Carlos Ramirez" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="cluster-visualization.html"/>
<link rel="next" href="markers-visualization.html"/>
<script src="libs/header-attrs-2.6/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> scRNA-Seq Course Syllabus</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#single-cell-sequencing"><i class="fa fa-check"></i><b>1.1</b> Single Cell Sequencing</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#quantifying-gene-expression-in-single-cells"><i class="fa fa-check"></i><b>1.2</b> Quantifying gene expression in single cells</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="standard-preprocessing-using-seurat.html"><a href="standard-preprocessing-using-seurat.html"><i class="fa fa-check"></i><b>2</b> Standard Preprocessing using Seurat</a>
<ul>
<li class="chapter" data-level="2.1" data-path="standard-preprocessing-using-seurat.html"><a href="standard-preprocessing-using-seurat.html#creating-seurat-object"><i class="fa fa-check"></i><b>2.1</b> Creating Seurat object</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="quality-control.html"><a href="quality-control.html"><i class="fa fa-check"></i><b>3</b> Quality control</a></li>
<li class="chapter" data-level="4" data-path="feature-selection.html"><a href="feature-selection.html"><i class="fa fa-check"></i><b>4</b> Feature selection</a></li>
<li class="chapter" data-level="5" data-path="dimensionional-reduction.html"><a href="dimensionional-reduction.html"><i class="fa fa-check"></i><b>5</b> Dimensionional Reduction</a>
<ul>
<li class="chapter" data-level="5.1" data-path="dimensionional-reduction.html"><a href="dimensionional-reduction.html#normalization"><i class="fa fa-check"></i><b>5.1</b> Normalization</a></li>
<li class="chapter" data-level="5.2" data-path="dimensionional-reduction.html"><a href="dimensionional-reduction.html#dimensional-reduction"><i class="fa fa-check"></i><b>5.2</b> Dimensional reduction</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="cell-clustering.html"><a href="cell-clustering.html"><i class="fa fa-check"></i><b>6</b> Cell clustering</a></li>
<li class="chapter" data-level="7" data-path="cluster-visualization.html"><a href="cluster-visualization.html"><i class="fa fa-check"></i><b>7</b> Cluster visualization</a>
<ul>
<li class="chapter" data-level="7.1" data-path="cluster-visualization.html"><a href="cluster-visualization.html#umap"><i class="fa fa-check"></i><b>7.1</b> UMAP</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="differential-expression-analysis.html"><a href="differential-expression-analysis.html"><i class="fa fa-check"></i><b>8</b> Differential Expression Analysis</a></li>
<li class="chapter" data-level="9" data-path="markers-visualization.html"><a href="markers-visualization.html"><i class="fa fa-check"></i><b>9</b> Markers visualization</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">IRTG COURSE: INTRODUCTION TO R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="differential-expression-analysis" class="section level1" number="8">
<h1><span class="header-section-number">8</span> Differential Expression Analysis</h1>
<p>The main advantage of using scRNA-Seq technologies is the possibility of
assessing cell type specificity and heterogeneity, which is not possible while
using bulk assays.</p>
<p>We should expect that some of the identified clusters in the UMAP might correspond
to distinct cell types. The assignation of cell types identities is not always
straightforward, some clusters might still contain some variability, and
additionally, different clusters might correspond to the same cell type at a
different functional, metabolic or cycling point.</p>
<p>Cell type profiling is generally done by assessing the expression of markers.
This task can be done manually by inspecting markers in dimensional reduced data
projected in UMAP or tSNE. It can also be done in a automatic manner scoring
cells using gene signatures, which are lists of marker genes. Scores are generally
based in the median expression of all the markers. Using scores has the advantage
or reducing bias due to the arbitrary selection of markers.</p>
<p>Finding differential expressed markers is important for cluster profiling and
identification. We will use the <code>FindAllMarkers()</code>, this functions performs
a statistical test comparing the distribution of gene expression values for
each gene separately comparing one assigned cell type cluster (in this case
the <code>seurat_clusters</code> column) <em>vs</em> the rest.</p>
<p>First, we will set up the column used to define the clusters using the
function <code>Idents()</code>.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="differential-expression-analysis.html#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(pbmc.seurat) <span class="ot">&lt;-</span> pbmc.seurat<span class="sc">$</span>seurat_clusters</span></code></pre></div>
<p>Now we can calculate the DEGs.
There are several parameters for <code>FindAllMarkers()</code>, we will discuss
<code>logfc.threshold</code>, <code>min.pct</code> and <code>min.cells.feature</code> that corresponds to the threshold of gene
expression fold change, the minimum percentage of cells expressing the marker
and the minimum of cells expressing (counts &gt; 0) the feature. These parameters
are used to filter out genes prior calculating DEGs. Lowering the values of these
parameters will increase the sensibility of the method at the expense of
increasing computation time.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="differential-expression-analysis.html#cb27-1" aria-hidden="true" tabindex="-1"></a>pbmc.degs <span class="ot">&lt;-</span> <span class="fu">FindAllMarkers</span>(pbmc.seurat, </span>
<span id="cb27-2"><a href="differential-expression-analysis.html#cb27-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">logfc.threshold =</span> <span class="dv">1</span>, </span>
<span id="cb27-3"><a href="differential-expression-analysis.html#cb27-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">min.pct =</span> <span class="fl">0.05</span>, </span>
<span id="cb27-4"><a href="differential-expression-analysis.html#cb27-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">min.cells.feature =</span> <span class="dv">10</span>, </span>
<span id="cb27-5"><a href="differential-expression-analysis.html#cb27-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>The output <code>pbmc.degs</code> consist of a data frame contanning the DEGs with
p-vales, p-adjusted values and log fold change values for each gene as
we can see next:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="differential-expression-analysis.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pbmc.degs)</span></code></pre></div>
<pre><code>##                 p_val avg_log2FC pct.1 pct.2    p_val_adj cluster     gene
## LDHB     1.904954e-47   1.676499 0.924 0.489 2.414148e-43       0     LDHB
## CD74     3.347159e-46  -2.889919 0.746 0.946 4.241855e-42       0     CD74
## CYBA     6.600780e-46  -1.641294 0.750 0.953 8.365168e-42       0     CYBA
## HLA-DRB1 9.890935e-44  -3.333839 0.103 0.703 1.253478e-39       0 HLA-DRB1
## HLA-DRA  2.565779e-42  -4.164359 0.295 0.768 3.251612e-38       0  HLA-DRA
## HLA-DPA1 8.697736e-37  -2.954716 0.205 0.717 1.102264e-32       0 HLA-DPA1</code></pre>
<p>We can make a vulcano plot using <code>ggplot</code>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="differential-expression-analysis.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb30-2"><a href="differential-expression-analysis.html#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)         <span class="do">## for handling data frames</span></span>
<span id="cb30-3"><a href="differential-expression-analysis.html#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb30-4"><a href="differential-expression-analysis.html#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="differential-expression-analysis.html#cb30-5" aria-hidden="true" tabindex="-1"></a>pbmc.degs <span class="sc">%&gt;%</span></span>
<span id="cb30-6"><a href="differential-expression-analysis.html#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(avg_log2FC))) <span class="sc">%&gt;%</span>       <span class="do">## Arranging genes by FC</span></span>
<span id="cb30-7"><a href="differential-expression-analysis.html#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rank=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(pbmc.degs)) <span class="sc">%&gt;%</span>        <span class="do">## Ranking markers by FC</span></span>
<span id="cb30-8"><a href="differential-expression-analysis.html#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">highlight=</span><span class="fu">ifelse</span>(rank<span class="sc">&lt;</span><span class="dv">20</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span> <span class="do">## highlighting top FC markers</span></span>
<span id="cb30-9"><a href="differential-expression-analysis.html#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_label=</span><span class="fu">ifelse</span>(highlight<span class="sc">==</span><span class="cn">TRUE</span>, gene, <span class="st">&#39;&#39;</span>)) <span class="sc">%&gt;%</span> <span class="do">## Adding labels for top markers</span></span>
<span id="cb30-10"><a href="differential-expression-analysis.html#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>avg_log2FC, <span class="at">y=</span><span class="sc">-</span><span class="fu">log10</span>(p_val_adj),</span>
<span id="cb30-11"><a href="differential-expression-analysis.html#cb30-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour=</span>highlight,</span>
<span id="cb30-12"><a href="differential-expression-analysis.html#cb30-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">label=</span>gene_label)) <span class="sc">+</span>         <span class="do">## adding labels for top markers</span></span>
<span id="cb30-13"><a href="differential-expression-analysis.html#cb30-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb30-14"><a href="differential-expression-analysis.html#cb30-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_text_repel</span>() <span class="sc">+</span></span>
<span id="cb30-15"><a href="differential-expression-analysis.html#cb30-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="course_files/figure-html/vulcano_plot-1.png" width="672" style="display: block; margin: auto;" /></p>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="cluster-visualization.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="markers-visualization.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
